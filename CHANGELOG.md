# Changelog

## AegisFlow Branding Unification (2026-02-26)

### 🎨 文档品牌统一

- ✅ 仓库主品牌名称统一为 `AegisFlow`
- ✅ 副标题统一为 `Transform, Validate, Deliver from a Single TOC`
- ✅ 更新主页文档与模块指南标题，保持品牌一致性
- ✅ 保持原有技术内容、流程说明与操作命令不变

## Python Runtime Migration (2026-02-24)

### 🔄 Python 3.13 迁移与启动修复

- ✅ 重建虚拟环境到 Python 3.13
- ✅ 修复 `test_environment.bat` 对缺失 `test_imports.py` 的依赖
- ✅ 新增 `test_imports.py` 用于依赖自检（pandas/openpyxl/tkinter）
- ✅ 更新所有核心启动器（`run_*.bat`）的解释器选择逻辑：
  - 优先使用可用的 `.venv\Scripts\python.exe`
  - 其次使用 `py -3.13`
  - 最后回退 `python`
- ✅ 更新文档中的版本与建环境命令（`py -3.13 -m venv .venv`）

## EXTRACT_PROGRAMS v1.0 (2026-02-12)

### 🎉 New Tool Release

#### Function Overview
- ✅ **Extract SAS Program List**: Extract PROGRAM list from Excel file generated by MOSAIC_CONVERT
- ✅ **Smart Statistical Analysis**: Count tocnumber quantity for each program
- ✅ **Preserve Order**: Arrange by first appearance order in Excel (preserve original order)
- ✅ **Centralized Comments**: All statistical info comments at file top
- ✅ **Standard Format Output**: Generate %runpgm format SAS script file
- ✅ **Graphical Interface**: Provide file selection dialog, user-friendly

#### Output Format
```sas
/* Generated SAS Program Execution Script */
/* Programs ordered by first appearance in Excel file */

/* Program Statistics: */
/*   t_ds: 3 table(s) */
/*   t_dm: 2 table(s) */

/* ====== Program Execution Commands ====== */

%runpgm(pgm=t_ds, error_override=y);
%runpgm(pgm=t_dm, error_override=y);
```

#### Use Cases
1. Batch run SAS programs
2. Quickly understand project program list and statistical info
3. Execute by Excel file original order, conforming to business logic
4. Program list management and quality control

#### File List
- `extract_programs.py` - Main Python script
- `run_extract_programs.bat` - Batch execution file
- `README_EXTRACT_PROGRAMS.md` - Detailed documentation

---

## MOSAIC_CONVERT v3.1 (2026-02-11)

### 🔧 核心修复

#### 1. OUTFILE列数据源修正
- ✅ **直接使用CSV原始值**: OUTFILE列不再从PROGRAM+SUFFIX拼接生成
  - 直接使用CSV中`parm='outfile'`对应的`value`值
  - 修复了某些情况下SUFFIX不为空但OUTFILE与PROGRAM相同的问题
  - 保留CSV中的实际业务逻辑，不做额外处理

#### 2. 中文路径编码修复
- ✅ **UTF-8编码支持**: 完全解决包含中文字符的路径问题
  - `.last_output.txt`改用UTF-8编码写入（之前是GBK）
  - `validate_output.py`自动从文件读取路径，避免bat传递中文路径
  - `run_mosaic_convert.bat`简化验证流程，不再通过命令行传递路径
  - 支持路径中包含中文（如"工具开发"）

### 📊 技术细节

| 修改项 | 修改前 | 修改后 |
|--------|--------|--------|
| **OUTFILE生成** | `PROGRAM + "_" + SUFFIX` | CSV中`parm='outfile'`的`value` |
| **.last_output.txt编码** | GBK | UTF-8 |
| **路径传递方式** | bat → Python (命令行参数) | Python自动读取文件 |

---

## 版本 3.0 (2026-02-11)

### 🎉 核心改进：按seq转置与完整检查机制

#### 1. seq序列转置
- ✅ **seq序列生成**: 基于CSV中'outfile'行自动生成
  - 起始值1，每遇outfile行则seq+1
  - 作为转置的基准单位
  - 最终生成249行唯一数据

#### 2. tocnumber唯一性检查
- ✅ **预检查机制**: 在转置前验证数据
  - 对"param=tocnumber"的行进行统计
  - 若行数 > 唯一值数，表示有重复
  - 错误时立即停止：ERROR: 有图表使用同样的toc number
  - 避免生成错误的输出文件

#### 3. program+suffix重复检测
- ✅ **转置后检测**: 在生成Index表后检查
  - 识别多张表使用相同的program+suffix组合
  - 警告信息：ERROR: 有图表使用同样的program+suffix,请更新MOSAIC
  - 在PROGRAM和SUFFIX列自动标黄
  - 程序继续运行并生成输出文件

#### 4. 非latin1字符保留原文本
- ✅ **字符标红不转换**: 
  - 自动检测非ASCII字符（如"–"破折号）
  - 仅对问题字符使用红色字体
  - 单元格使用绿色背景
  - 原文本完全保留，不删除、不转换

#### 5. 控制台编码修复
- ✅ **避免乱码**: 所有输出符号改为ASCII
  - ✓→OK, ❌→ERROR, ⚠→WARN
  - 兼容Windows GBK编码

### 📊 数据统计

| 指标 | 详情 |
|------|------|
| **总行数** | 249 (基于seq转置) |
| **Output Type** | Table(200) + Figure(27) + Listing(17) |
| **重复program+suffix** | 8行（已标黄） |
| **唯一tocnumber** | 249 |
| **数据完整性** | 100% |

---

## 版本 2.5 (2026-02-10)

### 🎉 新增功能与修复

#### 1. 数值排序修复
- ✅ **修改了tocnumber排序逻辑**
  - 从字符串排序改为数值排序
  - 现在 14.1.2 正确地出现在 14.1.10 之前
  - 递归支持任意嵌套深度的编号
  - 实现了 `tocnumber_sort_key()` 函数

#### 2. 富文本格式化
- ✅ **非latin1字符自动标红**
  - 仅对问题字符使用红色，不是整行
  - 使用RichText实现个别字符的格式化
  - 包含 `CellRichText` 和 `TextBlock` 导入
  
- ✅ **非latin1单元格绿色背景**
  - 整个单元格使用绿色（92D050）
  - 便于快速定位问题字符
  - 例如："Primary Endpoint – Progression"中的破折号

#### 3. 共享program+suffix标记
- ✅ **黄色背景标记**
  - tocnumber/PROGRAM/SUFFIX三列标记
  - 强调31个共享的program+suffix组合
  - 影响66个tocnumber

#### 4. 全局字体统一
- ✅ **所有单元格使用"等线"字体**
  - 表头：等线 + 加粗
  - 数据：等线
  - 富文本部分：等线

#### 5. 完整的数据恢复（v2.4）
- ✅ **245张表全部保留**
  - 从210恢复到245
  - 使用tocnumber作为唯一标识符
  - 检测并标记31个共享的program+suffix组合

### 📊 数据统计

| 指标 | 详情 |
|------|------|
| **总表格数** | 245 (基于唯一tocnumber) |
| **原始CSV行** | 3,211 |
| **共享组合** | 31个program+suffix |
| **受影响tocnumber** | 66个 |
| **非latin1单元格** | 59个 |
| **黄色标记单元格** | 198个 (66×3列) |

### 💻 技术实现

```python
def tocnumber_sort_key(tocnum):
    """数值排序实现"""
    if pd.isna(tocnum):
        return (float('inf'),)
    parts = str(tocnum).split('.')
    return tuple(int(p) if p.isdigit() else float('inf') for p in parts)

def create_rich_text(text, non_latin1_positions):
    """富文本格式化实现"""
    # 检测并标红非latin1字符
    # 保持其他字符为默认颜色
```

---

## 版本 2.4 (2026-02-10)

### 🎉 数据完整性修复

#### 1. 从210恢复到245张表
- ✅ 使用tocnumber作为唯一标识符（而不是program+suffix）
- ✅ 保留了35张被合并的表
- ✅ 解决了多个tocnumber共享同一program+suffix的问题

#### 2. 共享标记识别
- ✅ 检测31个shared的program+suffix组合
- ✅ 标记66个受影响的tocnumber
- ✅ 提供了详细的组合列表

#### 3. 模板脚注过滤
- ✅ 自动检测和移除占位符脚注
- ✅ 支持多种格式的占位符检测

---

## 版本 2.3 (2026-02-09)

### 🎉 预处理功能细化

#### 1. Footnote-only处理
- ✅ 仅对footnote列处理单引号
- ✅ title列保持原样不处理
- ✅ 其他列不受影响

---

## 版本 2.2 (2026-02-09)

### 🎉 文件选择改进

#### 1. 文件选择对话框
- ✅ 动态输入文件选择（tkinter）
- ✅ 动态输出文件保存位置

---

## 版本 2.1 (2026-02-09)

### 🎉 初始预处理

#### 1. Quote处理
- ✅ 针对title和footnote的单引号处理
- ✅ 自动替换第一个和最后一个单引号

---

## 版本 2.0 (2026-02-09)

### 🎉 初始功能完成

#### 1. VBA宏转换
- ✅ 完整的数据重组逻辑
- ✅ 参数展开和聚合
- ✅ Excel格式化

#### 2. 文件选择对话框
- ✅ **输入文件选择**: 不再需要固定路径，运行时会弹出文件选择对话框
  - 可以选择任意位置的CSV文件
  - 支持文件类型过滤（只显示.csv文件）
  - 支持中文路径和文件名
  
- ✅ **输出文件选择**: 可以自由指定输出位置和文件名
  - 弹出文件保存对话框
  - 默认文件名为：`<输入文件名>_MOSAIC_CONVERT.xlsx`

#### 3. 数据预处理功能
- ✅ **自动处理单引号**: 针对footnote类型的参数（不包括title）

### 📊 输出示例

```
✓ 转换完成！输出文件: Clinical Study Report_TiFo_MOSAIC_CONVERT.xlsx
  - 处理了 3211 行原始数据
  - 生成了 245 行索引数据 ✓✓✓ 转换成功！
```

---

## 版本 1.0 (初始版本)

初始VBA宏转Python的基础实现
处理后: rtf
说明: 不是footnote开头，不做任何处理
```

### 🔧 技术改进

1. **新增依赖**: tkinter（Python标准库，通常已内置）
2. **新增函数**:
   - `preprocess_csv_data()`: 预处理CSV数据
   - `select_input_file()`: 文件选择对话框
   - `select_output_file()`: 文件保存对话框
3. **改进主流程**: 交互式文件选择，更好的用户体验

### 📝 使用方式

#### 最简单的方式
```bash
python mosaic_convert.py
```
然后在弹出的对话框中选择文件即可。

#### 也可以在代码中调用（编程方式不变）
```python
from mosaic_convert import mosaic_convert

# 仍然支持直接指定路径
mosaic_convert("input.csv", "output.xlsx")
```

### ⚠️ 重要说明

1. **预处理规则**: 严格按照用户要求，只处理footnote
   - title类型的参数保持原样，不做任何处理
   - 只有footnote开头的parm才会处理：替换第一个和最后一个单引号
   - 这是明确的需求："除了第一个和最后一个以外的单引号不要做任何修改"

2. **取消操作**: 
   - 如果在文件选择对话框中点击"取消"，程序会安全退出
   - 不会对任何文件进行修改

3. **文件覆盖**: 
   - 如果选择的输出文件已存在，系统会提示是否覆盖
   - 请注意备份重要文件

### 🐛 修复问题

- ✅ 问题1: 输入文件路径固定 → 改为对话框选择
- ✅ 问题2: 输出文件路径固定 → 改为对话框选择  
- ✅ 问题3: 缺少数据预处理 → 新增自动预处理功能

---

## 版本 1.0 (2026-02-10)

### 初始版本
- ✅ VBA宏转换为Python
- ✅ CSV到XLSX转换
- ✅ 数据透视和重组
- ✅ Excel格式化
- ✅ 创建Index和Original工作表

---

**维护者**: AI Assistant  
**项目**: MOSAIC_CONVERT  
**状态**: ✅ 稳定运行
